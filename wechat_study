
to make service account menu come into effect, unsubscribe and then resubscribe.


[ahye@tz8-server001 vote-dev.yqtz8.com]$ php yii tools/create-wechat-menu
PHP Warning:  Module 'gd' already loaded in Unknown on line 0
{"button":[{"type":"view","name":"æˆ‘çš„æŠ•ç¥¨","url":"https:\/\/vote-dev.yqtz8.com\/vote\/list"},{"type":"view","name":"å‘èµ·æŠ•ç¥¨","url":"https:\/\/vote-dev.yqtz8.com\/vote\/create"},{"name":"æŒ‘æˆ˜","sub_button":[{"type":"view","name":"æˆ‘çš„æŒ‘æˆ˜","url":"https:\/\/wx-dev.yqtz8.com\/mission\/list"},{"type":"view","name":"å‘èµ·æŒ‘æˆ˜","url":"https:\/\/wx-dev.yqtz8.com\/mission\/create"},{"type":"click","name":"æˆ‘è¦æ‰“å¡","key":"BUTTON_CHECKIN"},{"type":"click","name":"é‚€è¯·äºŒç»´ç ","key":"BUTTON_TEMP_QRCODE"},{"type":"click","name":"ç¤¾äº¤","key":"BUTTON_SOCIAL"}]}]}array(2) {
  ["res"]=>
  string(27) "{"errcode":0,"errmsg":"ok"}"
  ["httpCode"]=>
  int(200)
}
Error: Module 'gd' already loaded


----------- 2016-11-26 14:45:15
wechat service account's menu url might have to be https-prefixed, needing ops to enable https support.


------------- 2016-11-25 13:50:32
changed from https to http, it takes lots of effort to take effect:
    restart, relogin, unsubscribe, etc.

class ToolsController extends Controller
{

    // Wechat custom menu
    private static $custom_menu = [
        "button" => [
            [
                "type" => "view",
                "name" => "æˆ‘çš„æŠ•ç¥¨",
                "url" => "https://vote-dev.yqtz8.com/vote/list"
            ],
            [
                "type" => "view",
                "name" => "å‘èµ·æŠ•ç¥¨",
                "url" => "https://vote-dev.yqtz8.com/vote/create"
            ],
            [
                "name" => "æŒ‘æˆ˜",
                "sub_button" => [
                    [
                        "type" => "view",
                        "name" => "æˆ‘çš„æŒ‘æˆ˜",
                        "url" => "https://wx-dev.yqtz8.com/mission/list"
                    ],
                    [
                        "type" => "view",
                        "name" => "å‘èµ·æŒ‘æˆ˜",
                        "url" => "https://wx-dev.yqtz8.com/mission/create"
                    ],
                    [
                        "type" => "click",
                        "name" => "æˆ‘è¦æ‰“å¡",
                        "key" => "BUTTON_CHECKIN"
                    ],
                    [
                        "type" => "click",
                        "name" => "é‚€è¯·äºŒç»´ç ",
                        "key" => "BUTTON_TEMP_QRCODE"
                    ],
                    [
                        "type" => "click",
                        "name" => "ç¤¾äº¤",
                        "key" => "BUTTON_SOCIAL"
                    ],
                ],
            ],
        ]
    ];

    public function actionUpdateUserinfo()
    {
        $accounts = Account::find()->all();
        foreach ($accounts as $account) {
            // æ²¡æœ‰open_idï¼Œå¯èƒ½æ˜¯ä»å®¢æˆ·ç«¯ç»‘å®šäº†å¾®ä¿¡å¸å·
            if (empty($account->open_id)) {
                continue;
            }
            $token = Wechat::getMpAccessToken();
            $resp = Wechat::getUserInfoCgi($account->open_id, $token);
            if (empty($resp)) {
                Logger::info('get userinfo for user ' . $account->nickname . ' failed');
                continue;
            } else {
                // update union id, head image and nickname
                $account->union_id = $resp['unionid'];
                if (!empty($resp['headimgurl'])) {
                    $account->avatar = $resp['headimgurl'];
                }
                if (!empty($resp['nickname'])) {
                    $account->nickname = $resp['nickname'];
                }
                $account->save();
            }
        }
    }

    public function actionCreateWechatMenu()
    {
        $token = Wechat::getMpAccessToken();
        if (!$token) {
            throw new AppException('è·å–access tokenå¤±è´¥');
        }
        $url = 'https://api.weixin.qq.com/cgi-bin/menu/create?access_token=' . $token;
        $menu_data = json_encode(self::$custom_menu, JSON_UNESCAPED_UNICODE);
        echo $menu_data;
        $res = Util::curl($method = 'POST', $url, $postData = $menu_data);
        var_dump($res);
    }


---------- 2016-10-27 13:37:14
authorization:
https://www.zhihu.com/question/24691963
    iosç‰ˆçš„å¾®ä¿¡ æ€ä¹ˆæ¸…é™¤å†…ç½®æµè§ˆå™¨çš„cookie? å·²æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼šé€€å‡ºå¾®ä¿¡è´¦å·ï¼Œé‡æ–°ç™»å½•

2016-10-27 13:36:47 [][info][abc\frontend\components\wxmp\MpManager::processMessage] no handler found for message: <xml><ToUserName><![CDATA[gh_ad456821e729]]></ToUserName>
<FromUserName><![CDATA[ook-7wLch8xSS-mM-urjLCCs91n0]]></FromUserName>
<CreateTime>1477546607</CreateTime>
<MsgType><![CDATA[event]]></MsgType>
<Event><![CDATA[VIEW]]></Event>
<EventKey><![CDATA[https://wx-dev.yqtz8.com/mission/create]]></EventKey>
<MenuId>408742541</MenuId>
</xml>
2016-10-27 13:36:47 [][info][abc\frontend\controllers\LoginController::getWechatLoginUrlBase] wechat login callback: https://wx-dev.yqtz8.com/login/wechat-login-callback
2016-10-27 13:36:47 [][info][abc\frontend\controllers\LoginController::actionIndex] Wechat Login Url: https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7a84fcbe9e98e97f&redirect_uri=https%3A%2F%2Fwx.yqtz8.com%2Fsite%2Fredirect%3Fredirect_url%3Dhttps%253A%252F%252Fwx-dev.yqtz8.com%252Flogin%252Fwechat-login-callback&response_type=code&scope=snsapi_base&state=base#wechat_redirect
2016-10-27 13:36:49 [-][info][abc\frontend\controllers\LoginController::actionWechatLoginCallback] used app id: wx7a84fcbe9e98e97f
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::handleWechatLoginCallback] wechat login callback, code: 031NqrnL1V84T11rkvnL1fklnL1Nqrng, appId: wx7a84fcbe9e98e97f
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::loginWithWechat] Call function with args: ["031NqrnL1V84T11rkvnL1fklnL1Nqrng","wx7a84fcbe9e98e97f","wx_pub"]
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Call function with args: ["https:\/\/api.weixin.qq.com\/sns\/oauth2\/access_token?appid=wx7a84fcbe9e98e97f&secret=4bc274f2609078248cb3f23a76a9df83&code=031NqrnL1V84T11rkvnL1fklnL1Nqrng&grant_type=authorization_code"]
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Response: {"access_token":"BnOSxODyMU5B4yCQpM0kPSRLtGVzOF6cwhZlN61p2mavmlbxd-OXK6mnaLc3H5MKrUCKWhZPxbWyFENb8PXI7JZD18NVdvI5059ZQB0Mgg0","expires_in":7200,"refresh_token":"sbeh1-Y7xfTvWbaa2LEEDNr9k1-GFJOlgrwzspFXpcS53hEjNo4Uyvy-TqKb-14QN1vbakbu3uXmqWBNMgIb1f8QtiXt48jBUE-5bCttNcY","openid":"ook-7wLch8xSS-mM-urjLCCs91n0","scope":"snsapi_base"}
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::getUserInfo] login with snsapi_base
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Call function with args: ["https:\/\/api.weixin.qq.com\/cgi-bin\/token?appid=wx7a84fcbe9e98e97f&secret=4bc274f2609078248cb3f23a76a9df83&grant_type=client_credential"]
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Response: {"access_token":"SI4gXc5YMX2MZo39F4NqiyJEkKuTzxMqiyno9M58YD71nvzEgd-FhDxm4yAl6rgxplI7eHJ93QDNMubExBRks8NLfuZKWNsRgf-zDXKit--2j65JaX4poBkJvwvAyW1oAVSgADAHCZ","expires_in":7200}
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Call function with args: ["https:\/\/api.weixin.qq.com\/cgi-bin\/user\/info?access_token=%s&openid=ook-7wLch8xSS-mM-urjLCCs91n0&lang=zh_CN","SI4gXc5YMX2MZo39F4NqiyJEkKuTzxMqiyno9M58YD71nvzEgd-FhDxm4yAl6rgxplI7eHJ93QDNMubExBRks8NLfuZKWNsRgf-zDXKit--2j65JaX4poBkJvwvAyW1oAVSgADAHCZ"]
2016-10-27 13:36:49 [-][info][abc\frontend\components\wxmp\Wechat::getContents] Response: {"subscribe":1,"openid":"ook-7wLch8xSS-mM-urjLCCs91n0","nickname":"å¶å®‰åğŸ‘€","sex":1,"language":"zh_CN","city":"æµ·æ·€","province":"åŒ—äº¬","country":"ä¸­å›½","headimgurl":"http:\/\/wx.qlogo.cn\/mmopen\/PiajxSqBRaEJkp2ibNelHjpXwSUzqSaUIVRJ8Lxd9HtLDxMic2ziasKXY52oW5RLNLEH203qBoXUiavuZsp0aDnGGtQ\/0","subscribe_time":1476419044,"unionid":"oNlIjwCTOL5Nw3LM2g0W_ro4k5X4","remark":"","groupid":0,"tagid_list":[]}
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::loginWithWechat] userinfo: {"subscribe":1,"openid":"ook-7wLch8xSS-mM-urjLCCs91n0","nickname":"å¶å®‰åğŸ‘€","sex":1,"language":"zh_CN","city":"æµ·æ·€","province":"åŒ—äº¬","country":"ä¸­å›½","headimgurl":"http://wx.qlogo.cn/mmopen/PiajxSqBRaEJkp2ibNelHjpXwSUzqSaUIVRJ8Lxd9HtLDxMic2ziasKXY52oW5RLNLEH203qBoXUiavuZsp0aDnGGtQ/0","subscribe_time":1476419044,"unionid":"oNlIjwCTOL5Nw3LM2g0W_ro4k5X4","remark":"","groupid":0,"tagid_list":[],"appId":"wx7a84fcbe9e98e97f"}
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::loginWithWechat] get account by openId: ook-7wLch8xSS-mM-urjLCCs91n0 unionId: oNlIjwCTOL5Nw3LM2g0W_ro4k5X4
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::loginWithWechat] account : 10 login..
2016-10-27 13:36:49 [-][info][abc\frontend\components\AccountManager::login] generateAccountToken 10
2016-10-27 13:36:49 [10][info][abc\frontend\components\AccountManager::loginWithWechat] å¶å®‰åğŸ‘£ç™»å½•æˆåŠŸ
2016-10-27 13:36:49 [10][info][abc\frontend\components\AccountManager::handleWechatLoginCallback] wechat login success
2016-10-27 13:36:52 [10][info][abc\frontend\components\MissionManager::checkResetMissionType] mission index, type defaults to 0
2016-10-27 13:36:52 [10][info][abc\frontend\controllers\MissionController::actionCreate] to render mission create: 
2016-10-27 13:36:54 [10][info][abc\frontend\controllers\ajax\MissionController::actionSharecontent] request share content: https://wx-dev.yqtz8.com/mission/create/



---------- 2016-10-14 12:24:48
if not subscribed: below will fail with message "æœªå…³æ³¨è¯¥æµ‹è¯•å·"
    https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx7a84fcbe9e98e97f&redirect_uri=https%3A%2F%2Fwx.yqtz8.com%2Fsite%2Fredirect%3Fredirect_url%3Dhttp%253A%252F%252Fwx-dev.yqtz8.com%252Flogin%252Fwechat-login-callback&response_type=code&scope=snsapi_userinfo&state=userinfo#wechat_redirect

------------ 2016-09-18 16:51:49

after modifying username for wechat, getUserInfo does not work immediately, not sure how long to take.
modify again and again seems not help. it just takes time, perhaps several hours.

below debug interface does not help. 
https://mp.weixin.qq.com/debug/cgi-bin/apiinfo?t=index&type=%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86&form=%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF%E6%8E%A5%E5%8F%A3%20/user/info

I'd rather access directly via:xxxxx&openid=xxxxx&lang=zh_CN
    however the response includes unreadable chinese characters as the returned is 

--------- 2016-09-03 17:43:36

the call might fail, just retry:
kidd@kidd-T430:~/workspace/php$ php get.php 
{"res":false,"httpCode":0}
kidd@kidd-T430:~/workspace/php$ php get.php 
{"res":"{\"access_token\":\"AnrdT88uFtTDZYzO3rVtr4sb0Z9b-QAzGJFKkwiDfIR0Ukkj-CkyenlMh9hWc-AIOSEaDznEhQMzXmuPUh19PjQ3uf0MyjeoLp8wBgOIbFO7LswdzPZcTQC-5C32Etj4DQZaAFAHUD\",\"expires_in\":7200}","httpCode":200}

------ 2016-09-06 13:11:27
wxpay
https://pay.weixin.qq.com/wiki/doc/api/tools/mch_pay.php?chapter=14_1
æ¸©é¦¨æç¤ºï¼š
    â—† ç»™åŒä¸€ä¸ªå®åç”¨æˆ·ä»˜æ¬¾ï¼Œå•ç¬”å•æ—¥é™é¢2W/2W
    â—† ç»™åŒä¸€ä¸ªéå®åç”¨æˆ·ä»˜æ¬¾ï¼Œå•ç¬”å•æ—¥é™é¢2000/2000
    â—† ä¸€ä¸ªå•†æˆ·åŒä¸€æ—¥ä»˜æ¬¾æ€»é¢é™é¢100W
    â—† ä»…æ”¯æŒå•†æˆ·å·å·²ç»‘å®šçš„APPIDï¼›
    â—† é’ˆå¯¹ä»˜æ¬¾çš„ç›®æ ‡ç”¨æˆ·ï¼Œå·²å¾®ä¿¡æ”¯ä»˜å®åè®¤è¯çš„ç”¨æˆ·å¯æä¾›æ ¡éªŒçœŸå®å§“åçš„åŠŸèƒ½ï¼Œæœªå®åè®¤è¯çš„ç”¨æˆ·æ— æ³•æ ¡éªŒï¼Œä¼ä¸šå¯æ ¹æ®è‡ªèº«ä¸šåŠ¡çš„å®‰å…¨çº§åˆ«é€‰æ‹©éªŒè¯ç±»å‹ï¼›
    â—† ä»˜æ¬¾é‡‘é¢å¿…é¡»å°äºæˆ–ç­‰äºå•†æˆ·å½“å‰å¯ç”¨ä½™é¢çš„é‡‘é¢ï¼›
    â—† å·²ä»˜æ¬¾çš„è®°å½•ï¼Œä¼ä¸šå¯é€šè¿‡ä¼ä¸šä»˜æ¬¾æŸ¥è¯¢æŸ¥çœ‹ç›¸åº”æ•°æ®ã€‚


------------- 2016-09-06 11:05:03
https://mp.weixin.qq.com/wiki/7/85eff372c164ddc66c47777dc972279f.html

å…¬ä¼—å·è°ƒç”¨æ¥å£å¹¶ä¸æ˜¯æ— é™åˆ¶çš„ã€‚ä¸ºäº†é˜²æ­¢å…¬ä¼—å·çš„ç¨‹åºé”™è¯¯è€Œå¼•å‘å¾®ä¿¡æœåŠ¡å™¨è´Ÿè½½å¼‚å¸¸ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå…¬ä¼—å·è°ƒç”¨æ¥å£éƒ½ä¸èƒ½è¶…è¿‡ä¸€å®šé™åˆ¶ï¼Œå½“è¶…è¿‡ä¸€å®šé™åˆ¶æ—¶ï¼Œè°ƒç”¨å¯¹åº”æ¥å£ä¼šæ”¶åˆ°å¦‚ä¸‹é”™è¯¯è¿”å›ç ï¼š

{"errcode":45009,"errmsg":"api freq out of limit"}

å¼€å‘è€…å¯ä»¥ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°ï¼Œåœ¨å¸å·åå°å¼€å‘è€…ä¸­å¿ƒæ¥å£æƒé™æ¨¡æ¿æŸ¥çœ‹å¸å·å„æ¥å£å½“å‰çš„æ—¥è°ƒç”¨ä¸Šé™å’Œå®æ—¶è°ƒç”¨é‡ï¼Œå¯¹äºè®¤è¯å¸å·å¯ä»¥å¯¹å®æ—¶è°ƒç”¨é‡æ¸…é›¶ï¼Œè¯´æ˜å¦‚ä¸‹ï¼š

1ã€ç›®å‰æ¸…é›¶åŠŸèƒ½åªå¯¹è®¤è¯å¸å·å¼€æ”¾ã€‚
2ã€ç”±äºæŒ‡æ ‡è®¡ç®—æ–¹æ³•æˆ–ç»Ÿè®¡æ—¶é—´å·®å¼‚ï¼Œå®æ—¶è°ƒç”¨é‡æ•°æ®å¯èƒ½ä¼šå‡ºç°è¯¯å·®ï¼Œä¸€èˆ¬åœ¨1%ä»¥å†…ã€‚
3ã€æ¯ä¸ªå¸å·æ¯æœˆå…±10æ¬¡æ¸…é›¶æ“ä½œæœºä¼šï¼Œæ¸…é›¶ç”Ÿæ•ˆä¸€æ¬¡å³ç”¨æ‰ä¸€æ¬¡æœºä¼šã€‚
4ã€æ¸…é›¶æœºä¼šå¯ä»¥10æ¬¡éƒ½ç”¨åœ¨å¯¹åŒä¸€ä¸ªæ¥å£è¿›è¡Œæ¸…é›¶ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ä¸åŒæ¥å£ä¸Šã€‚
5ã€æ¯ä¸ªæœ‰æ¥å£è°ƒç”¨é™é¢çš„æ¥å£éƒ½å¯ä»¥è¿›è¡Œæ¸…é›¶æ“ä½œã€‚
6ã€æ¸…é›¶ä¸€æ¬¡åï¼Œåªæœ‰ç¡®è®¤æ¸…é›¶çš„æ¥å£æ‰ä¼šç”Ÿæ•ˆï¼Œä¸æ˜¯æ¸…é›¶æ‰€æœ‰æ¥å£ã€‚

--------- 2016-09-05 14:24:01
wxpay:

http://zhidao.baidu.com/link?url=9JNX3KG-XtAljlg1JDOIvP054Q9xCXrIDoOIye2pbn6XnEvajixT3IlQYkXmz2JDBVqRQNzp927WlAtNEZSb_aQQwhSY4A1XdXMz_-uOS2C
å¾®ä¿¡æ”¯ä»˜æ˜¯æœ‰ä¸€å®šçš„é™é¢çš„ï¼Œç”¨æˆ·è½¬è´¦ä»˜æ¬¾å•ç¬”å•æ—¥é™é¢20000å…ƒï¼Œæ”¶æ¬¾æ— é™é¢ï¼›æœªæ·»åŠ è¿‡é“¶è¡Œå¡çš„ç”¨æˆ·è½¬è´¦ä»˜æ¬¾å•ç¬”å•æ—¥é™é¢200å…ƒï¼Œæ”¶æ¬¾å•ç¬”å•æ—¥é™é¢3000å…ƒã€‚è¶…è¿‡é™é¢åè‹¥æƒ³ç»§ç»­ä½¿ç”¨ï¼Œéœ€è¦æ·»åŠ ä¸€å¼ é“¶è¡Œå¡ï¼ŒéªŒè¯èº«ä»½ä¿¡æ¯ã€‚è¿™æ˜¯å®˜æ–¹ç»™å‡ºçš„å…·ä½“é™é¢ï¼Œä½ å¯ä»¥æ ¹æ®ä½ è‡ªå·±çš„æ¡ä»¶æ¥é€‰æ‹©æ”¯ä»˜ã€‚å¦‚æœè¶…å‡ºé™é¢ï¼Œå°±å¦‚ä¸Šé¢ä»‹ç»ï¼Œå¯ä»¥æ›´æ¢é“¶è¡Œå¡è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æ”¯ä»˜éƒ½æ˜¯åŠæ—¶åˆ°è´¦çš„ï¼Œå¦‚æœæ˜¯è½¬è´¦ï¼Œåœ¨ä¸¤ä¸ªå°æ—¶å†…å°±ä¼šå®Œæˆã€‚


http://www.cnblogs.com/txw1958/p/weixin-redpackets.html
ä¸€ã€å¾®ä¿¡çº¢åŒ…SDK
ç°é‡‘çº¢åŒ…ã€è£‚å˜çº¢åŒ…ã€ä¼ä¸šä»˜æ¬¾æœ¬è´¨å‡ä¸ºå•†æˆ·å’Œç”¨æˆ·ä¹‹é—´çš„è½¬è´¦ï¼Œå¾®ä¿¡å®˜æ–¹å®šä¹‰å…¶æ¥å£æ—¶ï¼Œæ“ä½œæ–¹æ³•ç±»ä¼¼ã€‚
1. è¯·æ±‚URL
ç°é‡‘çº¢åŒ…
https://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack
è£‚å˜çº¢åŒ…
https://api.mch.weixin.qq.com/mmpaymkttransfers/sendgroupredpack
ä¼ä¸šä»˜æ¬¾
https://api.mch.weixin.qq.com/mmpaymkttransfers/promotion/transfers

http://www.cnblogs.com/txw1958/p/weixin-redpackets.html
ä¼ä¸šä»˜æ¬¾æŸ¥è¯¢è°ƒç”¨æ–¹æ³•

http://zhidao.baidu.com/link?url=5j_MvjehNaNZtfXnHibwOcGejOWG-lhPatqrLm45udFyQzVXsAfdKeCiWp4Y3VGskS-RBtELiIzvFC2HuEExIklcJHfDG05OMQZ7mpEGdxO
å¾®ä¿¡æ”¯ä»˜æ˜¯é›†æˆåœ¨å¾®ä¿¡å®¢æˆ·ç«¯çš„æ”¯ä»˜åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡æ‰‹æœºå®Œæˆå¿«é€Ÿçš„æ”¯ä»˜æµç¨‹ã€‚å¾®ä¿¡æ”¯ä»˜ä»¥ç»‘å®šé“¶è¡Œå¡çš„å¿«æ·æ”¯ä»˜ä¸ºåŸºç¡€ï¼Œå‘ç”¨æˆ·æä¾›å®‰å…¨ã€å¿«æ·ã€é«˜æ•ˆçš„æ”¯ä»˜æœåŠ¡ã€‚
ã€€ã€€å¾®ä¿¡æ”¯ä»˜å¼€é€šæ¡ä»¶ï¼š
ã€€ã€€1)æ‹¥æœ‰å…¬ä¼—å¸å·ï¼Œä¸”ä¸ºæœåŠ¡å·;
ã€€ã€€2)å…¬ä¼—å¸å·é¡»é€šè¿‡å¾®ä¿¡è®¤è¯;(æœªè®¤è¯ç”¨æˆ·ï¼Œå¯å…ˆç”³è¯·å¾®ä¿¡è®¤è¯);
ä¸è¿‡å¯¹äºå•†å®¶æ¥è¯´ï¼Œç”¨æˆ·å–œæ¬¢ä»€ä¹ˆæ”¯ä»˜æ–¹å¼å•†å®¶å°±è¦å…·å¤‡ä»€ä¹ˆæ ·çš„æ”¯ä»˜åŠŸèƒ½ã€‚é™¤äº†å¾®ä¿¡æ”¯ä»˜å¤–ï¼Œæ”¯ä»˜å®ä¹Ÿæ˜¯å•†å®¶æœ€å¸¸ç”¨çš„æ”¯ä»˜æ–¹å¼ã€‚åƒå¾®ç›Ÿ(weimob)å¹³å°çš„å¾®ç›Ÿæ”¯ä»˜é™¤äº†å¾®ä¿¡æ”¯ä»˜è¿˜ï¼Œè¿˜æ•´åˆäº†æ”¯ä»˜å®ã€è´¢ä»˜é€šã€é“¶è”ä¸‰å¤§åœ¨çº¿æ”¯ä»˜åŠŸèƒ½ï¼Œé¿å…æ¶ˆè´¹è€…åœ¨æ”¯ä»˜ç¯èŠ‚çš„è·³å‡ºã€‚

https://pay.weixin.qq.com/wiki/doc/api/jsapi.php?chapter=9_6


1. å·²ç»è§£å†³ï¼Œéœ€è¦å…³æ³¨ä¸¤å¤©åï¼Œæ‰ä¼šå‡ºç°çº¢åŒ…çš„å½¢å¼
2. wechat version

æˆ‘çš„å¾®ä¿¡çš„ç‰ˆæœ¬æ˜¯6.3ï¼ŒæŒ‰ç…§æ–‡æ¡£ä¸Šçš„è¯´æ˜åº”è¯¥æ˜¯ä»¥çº¢åŒ…çš„å½¢å¼æ¥æ”¶ï¼Œä½†ç°åœ¨å´è¿˜æ˜¯æ¶ˆæ¯çš„å½¢å¼ã€‚ä¼šä¸ä¼šæ˜¯åº”è¯¥æˆ‘æ˜¯åœ¨å¾®ä¿¡å•†æˆ·çš„åå°ç®¡ç†ï¼Œæ‰‹åŠ¨å‘é€æµ‹è¯•çœ‹çœ‹çš„ï¼Œæ²¡æœ‰è°ƒç”¨å¾®ä¿¡æä¾›çš„apiè¿›è¡Œå‘æ”¾ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿™æ ·é—®é¢˜ã€‚æˆ‘åœ¨è‡ªå·±çš„æœåŠ¡å™¨ç«¯è°ƒç”¨è¿™ä¸ªhttps://api.mch.weixin.qq.com/mmpaymkttransfers/sendredpack apiæ¥å£ï¼Œå‘æ”¾å°±ä¸ä¼šå‡ºç°ç°åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥å‡ºç°çº¢åŒ…çš„å½¢å¼ï¼Ÿï¼ˆæ­£åœ¨æ­æœåŠ¡å™¨ç«¯ç¯å¢ƒï¼Œè¿˜æ²¡æ­å¥½ï¼Œæ‰€ä»¥æš‚æ—¶æµ‹è¯•ä¸äº†ï¼‰


https://pay.weixin.qq.com/index.php/public/cms/content_detail?lang=zh&id=6000
ç°é‡‘çº¢åŒ…è§¦è¾¾æ¶ˆæ¯è§„åˆ™
    ç°é‡‘çº¢åŒ…å‘æ”¾åä¼šä»¥å…¬ä¼—å·æ¶ˆæ¯çš„å½¢å¼è§¦è¾¾ç”¨æˆ·ï¼Œä¸åŒæƒ…å†µä¸‹è§¦è¾¾æ¶ˆæ¯çš„å½¢å¼ä¼šæœ‰å·®åˆ«
http://www.zhihu.com/question/39042856
    å¾®ä¿¡ä¼ä¸šçº¢åŒ…å‘æ”¾åˆ°ä¸ªäººå¾®ä¿¡å·ï¼Œæœ‰çš„æ˜¾ç¤ºæ˜¯æ­£å¸¸ä¸ªäººçº¢åŒ…çš„æ ·å­ï¼Œæœ‰çš„æ˜¾ç¤ºæ˜¯ä¸€ä¸ªæ¨¡æ¿æ¶ˆæ¯ï¼šæ‚¨æ”¶åˆ°ä¸€ä¸ªçº¢åŒ…...æ€ä¹ˆç ´ï¼Ÿ
    ä¸€æ–¹é¢æ˜¯6.1ç‰ˆæœ¬ï¼Œè¿™ä¸ªæ–‡æ¡£é‡Œå¾ˆæ¸…æ¥šï¼›æ–‡æ¡£æ²¡è¯´æ¸…æ¥šçš„æ˜¯ å¦å¤–è¿˜æœ‰å…³æ³¨æ—¶é—´çš„é™åˆ¶ï¼Œ<=50å°æ—¶ï¼Œä¹Ÿæ˜¯æ¨¡æ¿æ¶ˆæ¯ï¼Œçœ‹è¿™ä¸ªç½‘å€

----------- 2016-08-31 20:46:05

å…¬ä¼—å·æç¤ºè¯¥å…¬ä¼—å·æš‚æ—¶æ— æ³•æä¾›æœåŠ¡çš„è§£å†³æ–¹æ³•
  make sure the wechat message handler returned 200.

------------- 2016-08-31 15:46:00

/home/kidd/workspace/bc/advanced/MissionImpossible/console/controllers/ToolsController.php


è‡ªå®šä¹‰èœå•åˆ›å»ºæ¥å£
https://mp.weixin.qq.com/wiki/10/0234e39a2025342c17a7d23595c6b40a.html


------------ 2016-08-31 16:01:15
note: 
$url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=".$mpAccessToken;
https://mp.weixin.qq.com/wiki/11/c88c270ae8935291626538f9c64bd123.html
å½“ç”¨æˆ·å’Œå…¬ä¼—å·äº§ç”Ÿç‰¹å®šåŠ¨ä½œçš„äº¤äº’æ—¶ï¼ˆå…·ä½“åŠ¨ä½œåˆ—è¡¨è¯·è§ä¸‹æ–¹è¯´æ˜ï¼‰ï¼Œå¾®ä¿¡å°†ä¼šæŠŠæ¶ˆæ¯æ•°æ®æ¨é€ç»™å¼€å‘è€…ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…ï¼ˆç›®å‰ä¿®æ”¹ä¸º48å°æ—¶ï¼‰è°ƒç”¨å®¢æœæ¥å£ï¼Œé€šè¿‡POSTä¸€ä¸ªJSONæ•°æ®åŒ…æ¥å‘é€æ¶ˆæ¯ç»™æ™®é€šç”¨æˆ·ã€‚æ­¤æ¥å£ä¸»è¦ç”¨äºå®¢æœç­‰æœ‰äººå·¥æ¶ˆæ¯å¤„ç†ç¯èŠ‚çš„åŠŸèƒ½ï¼Œæ–¹ä¾¿å¼€å‘è€…ä¸ºç”¨æˆ·æä¾›æ›´åŠ ä¼˜è´¨çš„æœåŠ¡ã€‚

ç›®å‰å…è®¸çš„åŠ¨ä½œåˆ—è¡¨å¦‚ä¸‹ï¼ˆå…¬ä¼—å¹³å°ä¼šæ ¹æ®è¿è¥æƒ…å†µæ›´æ–°è¯¥åˆ—è¡¨ï¼Œä¸åŒåŠ¨ä½œè§¦å‘åï¼Œå…è®¸çš„å®¢æœæ¥å£ä¸‹å‘æ¶ˆæ¯æ¡æ•°ä¸åŒï¼Œä¸‹å‘æ¡æ•°è¾¾åˆ°ä¸Šé™åï¼Œä¼šé‡åˆ°é”™è¯¯è¿”å›ç ï¼Œå…·ä½“è¯·è§è¿”å›ç è¯´æ˜é¡µï¼‰ï¼š
1ã€ç”¨æˆ·å‘é€ä¿¡æ¯
2ã€ç‚¹å‡»è‡ªå®šä¹‰èœå•ï¼ˆä»…æœ‰ç‚¹å‡»æ¨äº‹ä»¶ã€æ‰«ç æ¨äº‹ä»¶ã€æ‰«ç æ¨äº‹ä»¶ä¸”å¼¹å‡ºâ€œæ¶ˆæ¯æ¥æ”¶ä¸­â€æç¤ºæ¡†è¿™3ç§èœå•ç±»å‹æ˜¯ä¼šè§¦å‘å®¢æœæ¥å£çš„ï¼‰
3ã€å…³æ³¨å…¬ä¼—å·
4ã€æ‰«æäºŒç»´ç 
5ã€æ”¯ä»˜æˆåŠŸ
6ã€ç”¨æˆ·ç»´æƒ
ä¸ºäº†å¸®åŠ©å…¬ä¼—å·ä½¿ç”¨ä¸åŒçš„å®¢æœèº«ä»½æœåŠ¡ä¸åŒçš„ç”¨æˆ·ç¾¤ä½“ï¼Œå®¢æœæ¥å£è¿›è¡Œäº†å‡çº§ï¼Œå¼€å‘è€…å¯ä»¥ç®¡ç†å®¢æœè´¦å·ï¼Œå¹¶è®¾ç½®å®¢æœè´¦å·çš„å¤´åƒå’Œæ˜µç§°ã€‚è¯¥èƒ½åŠ›é’ˆå¯¹æ‰€æœ‰æ‹¥æœ‰å®¢æœæ¥å£æƒé™çš„å…¬ä¼—å·å¼€æ”¾ã€‚
å¦å¤–ï¼Œè¯·å¼€å‘è€…æ³¨æ„ï¼Œæœ¬æ¥å£ä¸­æ‰€æœ‰ä½¿ç”¨åˆ°media_idçš„åœ°æ–¹ï¼Œç°åœ¨éƒ½å¯ä»¥ä½¿ç”¨ç´ æç®¡ç†ä¸­çš„æ°¸ä¹…ç´ æmedia_idäº†ã€‚ 

2016-08-31 16:00:53 [-][error][abc\frontend\components\wxmp\Wechat::postContents] {"errcode":45015,"errmsg":"response out of time limit or subscription is canceled hint: [uH3rka0454ge11]"}
    in /home/kidd/workspace/bc/advanced/MissionImpossible/frontend/components/util/Logger.php:25
    in /home/kidd/workspace/bc/advanced/MissionImpossible/frontend/components/wxmp/Wechat.php:375
    in /home/kidd/workspace/bc/advanced/MissionImpossible/frontend/components/wxmp/Wechat.php:184

    public function actionSendTemporary() {
        // get user open id
        $account_id = $_COOKIE[AccountManager::USER_ID];
        $account = Account::findOne($account_id);
        if(is_null($account)) {
            throw new AppException("Account not existing");
        }
        $open_id = $account->open_id;
//        $open_id = "ook-7wLch8xSS-mM-urjLCCs91n0";

        // step 1: generate temporary qrcode url
        $response = $this->getTemporary();
        $ticket = $response['ticket'];
        $url = "https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=$ticket";

        // step 2: download image to local
        $filename = uniqid(date("Y_m_d_H_i_s_")).".jpg";
        $full_file_path = Yii::$app->runtimepath."/images/".$filename;
        Util::curl_get_image($url, $full_file_path);

        // step 3: upload the image to wechat and get media id
        $media_id = Wechat::postImageToServer($full_file_path);

        Logger::info("to post image");
        // step 4: send image to user
        if($media_id !== false) {
            Logger::info("to post message to: ".$open_id);
            Wechat::postImageToUser($open_id, $media_id);
        }

    }


    public static function postImageToUser($open_id, $media_id) {
        $post_data = array(
            'touser' => $open_id,
            'msgtype' => 'image',
            'image' => array(
                'media_id' => $media_id,
            )
        );

        return static::postMessageToUser($post_data);
    }

    public static function postTextToUser($open_id, $content) {
        $post_data = array(
            'touser' => $open_id,
            'msgtype' => 'text',
            'text' => array(
                'content' => $content
            )
        );

        return static::postMessageToUser($post_data);
    }

    public static function postMessageToUser($post_data_array) {
        $mpAccessToken = static::getMpAccessToken();
        if(!empty($mpAccessToken)){
            $data_string = json_encode($post_data_array);
            $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=".$mpAccessToken;
            $header = array(
                'Content-Type: application/json',
                'Content-Length: ' . strlen($data_string));
            $response = static::postContents($url, $data_string, $header, $mpAccessToken);
            if($response === false) {
                Logger::error("failed to post message, Wechat::postContents failed");
            }
        }
        else {
            Logger::error("failed to post message, access token not available");
            return false;
        }

        return $response;
    }

    private function http_post_media($url,$strPOST)
    {
        $oCurl = curl_init ();
//        curl_setopt ( $oCurl, CURLOPT_SAFE_UPLOAD, false);
//        curl_setopt($oCurl, CURLOPT_POSTFIELDS, array(
//            'file' => '@'.realpath('image.png'),
//        ));

        if (stripos ( $url, "https://" ) !== FALSE) {
            curl_setopt ( $oCurl, CURLOPT_SSL_VERIFYPEER, FALSE );
            curl_setopt ( $oCurl, CURLOPT_SSL_VERIFYHOST, false );
        }

        curl_setopt ( $oCurl, CURLOPT_URL, $url );
        curl_setopt ( $oCurl, CURLOPT_RETURNTRANSFER, 1 );
        curl_setopt ( $oCurl, CURLOPT_POST, true );
        curl_setopt ( $oCurl, CURLOPT_POSTFIELDS, $strPOST );
        $sContent = curl_exec ( $oCurl );
        $aStatus = curl_getinfo ( $oCurl );
        curl_close ( $oCurl );
        if (intval ( $aStatus ["http_code"] ) == 200) {
            return $sContent;
        } else {
            return false;
        }

    }

    public static function upload($url, $filedata) {
        $curl = curl_init ();
        if (class_exists ( '/CURLFile' )) {//php5.5è·Ÿphp5.6ä¸­çš„CURLOPT_SAFE_UPLOADçš„é»˜è®¤å€¼ä¸åŒ
//            curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, true );
        } else {
            if (defined ( 'CURLOPT_SAFE_UPLOAD' )) {
//                curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, false );
            }
        }
        curl_setopt ( $curl, CURLOPT_URL, $url );
        curl_setopt ( $curl, CURLOPT_SSL_VERIFYPEER, FALSE );
        curl_setopt ( $curl, CURLOPT_SSL_VERIFYHOST, FALSE );
        if (! empty ( $filedata )) {
            curl_setopt ( $curl, CURLOPT_POST, 1 );
            curl_setopt ( $curl, CURLOPT_POSTFIELDS, $filedata );
        }
        curl_setopt ( $curl, CURLOPT_RETURNTRANSFER, 1 );
        $output = curl_exec ( $curl );
        curl_close ( $curl );
        return $output;

    }

    public static function postImageToServer($path=null) {
        $mpAccessToken = static::getMpAccessToken();
        if(!empty($mpAccessToken)){

            $filepath = "/home/kidd/tmp/test.jpeg";
            if($path != null) $filepath = $path;
            if (class_exists ( '\CURLFile' )) { //å…³é”®æ˜¯åˆ¤æ–­curlfile,å®˜ç½‘æ¨èphp5.5æˆ–æ›´é«˜çš„ç‰ˆæœ¬ä½¿ç”¨curlfileæ¥å®ä¾‹æ–‡ä»¶
                $filedata = array (
                    'fieldname' => new \CURLFile ( realpath ( $filepath ), 'image/jpeg' )
                );
            } else {
                $filedata = array (
                    'fieldname' => '@' . realpath ( $filepath )
                );
            }
            $url = "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=" . $mpAccessToken . "&type=image";
            $result = self::http_post_media ( $url, $filedata );//è°ƒç”¨uploadå‡½æ•°
            if(!$result) return false;
            else {
                $arr = json_decode($result, true);
                Logger::info("result: ".$result);
                $url = "http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=$mpAccessToken&media_id=".$arr['media_id'];
                Logger::info("got image url: ".$url);
                return $arr['media_id'];
            }

//
//            $type = "image";
//            $filepath = "/home/kidd/tmp/test.jpeg";
//
//            $post_data = array(
//                'fieldname' => '@'.realpath($filepath),
//            );
//
//            if (class_exists ( '\CURLFile' )) {//å…³é”®æ˜¯åˆ¤æ–­curlfile,å®˜ç½‘æ¨èphp5.5æˆ–æ›´é«˜çš„ç‰ˆæœ¬ä½¿ç”¨curlfileæ¥å®ä¾‹æ–‡ä»¶
//                Logger::info("CURLFILE exists");
//                $post_data = array (
//                    'fieldname' => new \CURLFile ( realpath ( $filepath ), 'image/jpeg' )
//                );
//            } else {
//                Logger::info("CURLFILE not exists");
//                $post_data = array (
//                    'fieldname' => '@' . realpath ( $filepath )
//                );
//            }
//
//            $data_string = json_encode($post_data);
//            Logger::info($data_string);
//
////            $url = "http://api.weixin.qq.com/cgi-bin/media/upload?access_token=$mpAccessToken&type=$type";
//            $url = "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=$mpAccessToken&type=$type";
//            $header = array(
//                'Content-Type: application/json',
//                'Content-Length: ' . strlen($data_string),
//                );
//            $response = static::postContents($url, $data_string, null, $mpAccessToken);
////            $response=self::http_post_media($url, $post_data);
        }
        else {

            return "failed to get access token";
        }

        return json_encode($response);
    }

    public static function postContents($url, $post_data, $header, $token=null, $try_count=0) {
        Logger::logFunctionCall();
        if ($try_count > self::MAX_TRY_COUNT) {
            Logger::warning('post contents failed, reach max try count');
            return false;
        }
        if (!is_null($token)) {
            $full_url = sprintf($url, $token);
        } else {
            $full_url = $url;
        }
        $response =  Util::curl('POST', $full_url, $post_data, $header);
        if(empty($response['res'])){
            Logger::warning('post contents failed, try again');
            return self::postContents($url, $post_data, $header, $token, $try_count+1);
        }
        Logger::info('Response: ' . $response['res']);

        $response = json_decode($response['res'], true);
        if(!empty($response['errcode'])) {
            Logger::error(json_encode($response));
            // check response, if token invalid, refresh token and try again
            if ($response['errcode'] == self::INVALID_TOKEN_CODE && !is_null($token)) {
                Logger::info('access token invalid, refresh token and try again');
                // refresh access token
                $new_token = self::getMpAccessToken(true);
                return self::postContents($url, $post_data, $header, $new_token, $try_count+1);
            }
            return false;
        }
        return $response;
    }

----------- 2016-08-31 12:23:40

ä¸‹è½½å¤šåª’ä½“æ–‡ä»¶

å…¬ä¼—å·å¯è°ƒç”¨æœ¬æ¥å£æ¥è·å–å¤šåª’ä½“æ–‡ä»¶ã€‚è¯·æ³¨æ„ï¼Œè§†é¢‘æ–‡ä»¶ä¸æ”¯æŒä¸‹è½½ï¼Œè°ƒç”¨è¯¥æ¥å£éœ€httpåè®®ã€‚

æ¥å£è°ƒç”¨è¯·æ±‚è¯´æ˜

httpè¯·æ±‚æ–¹å¼: GET
http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&media_id=MEDIA_ID
è¯·æ±‚ç¤ºä¾‹ï¼ˆç¤ºä¾‹ä¸ºé€šè¿‡curlå‘½ä»¤è·å–å¤šåª’ä½“æ–‡ä»¶ï¼‰
curl -I -G "http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=ACCESS_TOKEN&media_id=MEDIA_ID"

http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=qLqQf_JtM0mC3JPSW6rmGj3wthXApTL-JLHxAbOXSyZW-UMbGRDG4OFGu73iT2ZI9WSFFVxMlzTuooCe3ZuILWdOShwm1hp1zJM-vcD5B5ug7fNgzSY_w7fGNcwxwPX8QFFeAGAXMM&media_id=Vuo8BIGQADx3vNYc8e6-OvJMafW1J2bsvmS3BM2a6noVkLoQADChvnvJKK_cxTQS

---------- 2016-08-31 11:08:29

https://mp.weixin.qq.com/wiki/11/c88c270ae8935291626538f9c64bd123.html
{
    "touser":"OPENID",
    "msgtype":"image",
    "image":
    {
      "media_id":"MEDIA_ID"
    }
}

https://mp.weixin.qq.com/wiki/15/2d353966323806a202cd2deaafe8e557.html
å…¬ä¼—å·ç»å¸¸æœ‰éœ€è¦ç”¨åˆ°ä¸€äº›ä¸´æ—¶æ€§çš„å¤šåª’ä½“ç´ æçš„åœºæ™¯ï¼Œä¾‹å¦‚åœ¨ä½¿ç”¨æ¥å£ç‰¹åˆ«æ˜¯å‘é€æ¶ˆæ¯æ—¶ï¼Œå¯¹å¤šåª’ä½“æ–‡ä»¶ã€å¤šåª’ä½“æ¶ˆæ¯çš„è·å–å’Œè°ƒç”¨ç­‰æ“ä½œï¼Œæ˜¯é€šè¿‡media_idæ¥è¿›è¡Œçš„ã€‚ç´ æç®¡ç†æ¥å£å¯¹æ‰€æœ‰è®¤è¯çš„è®¢é˜…å·å’ŒæœåŠ¡å·å¼€æ”¾ï¼ˆæ³¨ï¼šè‡ªå®šä¹‰èœå•æ¥å£å’Œç´ æç®¡ç†æ¥å£å‘ç¬¬ä¸‰æ–¹å¹³å°æ——ä¸‹æœªè®¤è¯è®¢é˜…å·å¼€æ”¾ï¼‰ã€‚é€šè¿‡æœ¬æ¥å£ï¼Œå…¬ä¼—å·å¯ä»¥æ–°å¢ä¸´æ—¶ç´ æï¼ˆå³ä¸Šä¼ ä¸´æ—¶å¤šåª’ä½“æ–‡ä»¶ï¼‰ã€‚ 
è¯·æ³¨æ„ï¼š
1ã€å¯¹äºä¸´æ—¶ç´ æï¼Œæ¯ä¸ªç´ æï¼ˆmedia_idï¼‰ä¼šåœ¨å¼€å‘è€…ä¸Šä¼ æˆ–ç²‰ä¸å‘é€åˆ°å¾®ä¿¡æœåŠ¡å™¨3å¤©åè‡ªåŠ¨åˆ é™¤ï¼ˆæ‰€ä»¥ç”¨æˆ·å‘é€ç»™å¼€å‘è€…çš„ç´ æï¼Œè‹¥å¼€å‘è€…éœ€è¦ï¼Œåº”å°½å¿«ä¸‹è½½åˆ°æœ¬åœ°ï¼‰ï¼Œä»¥èŠ‚çœæœåŠ¡å™¨èµ„æºã€‚
2ã€media_idæ˜¯å¯å¤ç”¨çš„ã€‚
3ã€ç´ æçš„æ ¼å¼å¤§å°ç­‰è¦æ±‚ä¸å…¬ä¼—å¹³å°å®˜ç½‘ä¸€è‡´ã€‚å…·ä½“æ˜¯ï¼Œå›¾ç‰‡å¤§å°ä¸è¶…è¿‡2Mï¼Œæ”¯æŒbmp/png/jpeg/jpg/gifæ ¼å¼ï¼Œè¯­éŸ³å¤§å°ä¸è¶…è¿‡2Mï¼Œé•¿åº¦ä¸è¶…è¿‡60ç§’ï¼ˆå…¬ä¼—å¹³å°å®˜ç½‘å¯ä»¥åœ¨æ–‡ç« ä¸­æ’å…¥å°äº30åˆ†é’Ÿçš„è¯­éŸ³ï¼Œä½†è¿™äº›è¯­éŸ³ä¸èƒ½ç”¨äºç¾¤å‘ç­‰åœºæ™¯ï¼Œåªèƒ½æ”¾åœ¨æ–‡ç« å†…ï¼Œè¿™æ–¹é¢æ¥å£æš‚ä¸æ”¯æŒï¼‰ï¼Œæ”¯æŒmp3/wma/wav/amræ ¼å¼
4ã€éœ€ä½¿ç”¨httpsè°ƒç”¨æœ¬æ¥å£ã€‚


https://mp.weixin.qq.com/debug/cgi-bin/apiinfo?t=index&type=%E5%9F%BA%E7%A1%80%E6%94%AF%E6%8C%81&form=%E5%A4%9A%E5%AA%92%E4%BD%93%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%8E%A5%E5%8F%A3%20/media/upload

åŸºç¡€æ”¯æŒ: å¤šåª’ä½“æ–‡ä»¶ä¸Šä¼ æ¥å£ /media/upload

è¯·æ±‚åœ°å€ï¼š
    http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=HA4WODWzDB81lMFqv-d7duJIMeYzo2ehx2O8nzul-rCfFul_v65gtUknObHNY8CjIq8tu0nbZxP0XoYGTgZIlKC2rjjq8r4DINMckwbYvZFy_3a2hYtRH3IvaZC6DPROHORiAIALSV&type=image 

è¿”å›ç»“æœ:

        200 OK

        Connection: keep-alive
        Date: Wed, 31 Aug 2016 03:43:05 GMT
        Content-Type: text/plain
        Content-Length: 118

        {
            "type": "image", 
            "media_id": "IVSGE451WKYrjvBaSDrTOoxvMfK31YjltkaadMZKPtcFr233VhHhVpIpNAdF_9iT", 
            "created_at": 1472614985
        }

æç¤º:
    Request successful 

1. 
$ curl -F media=@/home/kidd/tmp/test.jpeg "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=mG4a3KAkgza263OaRf_wDkIzqM61c4ee4FoieCtE4YkXWSwLMkoVMdUb07I09sIZTgXntjOqJ6cvm4u3EXiZK6eQpnK0ekCE28F71nOSH3rFU60iifMN4mn_UAfaNzq4NRFhAHASWK&type=image"
{"type":"image","media_id":"BQxsSMFrq0YSvdCP9R2NC0NT16zXpGCghfD5EMKJhtDYkl1cefVDk-CnTBK7xMQf","created_at":1472615790}

2. one fix:
http://blog.csdn.net/hongtu1993/article/details/40784355

    private function http_post_media($url,$strPOST)
    {
        $oCurl = curl_init ();
//        curl_setopt ( $oCurl, CURLOPT_SAFE_UPLOAD, false);
//        curl_setopt($oCurl, CURLOPT_POSTFIELDS, array(
//            'file' => '@'.realpath('image.png'),
//        ));

        if (stripos ( $url, "https://" ) !== FALSE) {
            curl_setopt ( $oCurl, CURLOPT_SSL_VERIFYPEER, FALSE );
            curl_setopt ( $oCurl, CURLOPT_SSL_VERIFYHOST, false );
        }

        curl_setopt ( $oCurl, CURLOPT_URL, $url );
        curl_setopt ( $oCurl, CURLOPT_RETURNTRANSFER, 1 );
        curl_setopt ( $oCurl, CURLOPT_POST, true );
        curl_setopt ( $oCurl, CURLOPT_POSTFIELDS, $strPOST );
        $sContent = curl_exec ( $oCurl );
        $aStatus = curl_getinfo ( $oCurl );
        curl_close ( $oCurl );
        if (intval ( $aStatus ["http_code"] ) == 200) {
            return $sContent;
        } else {
            return false;
        }

    }

    public static function upload($url, $filedata) {
        $curl = curl_init ();
        if (class_exists ( '/CURLFile' )) {//php5.5è·Ÿphp5.6ä¸­çš„CURLOPT_SAFE_UPLOADçš„é»˜è®¤å€¼ä¸åŒ
//            curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, true );
        } else {
            if (defined ( 'CURLOPT_SAFE_UPLOAD' )) {
//                curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, false );
            }
        }
        curl_setopt ( $curl, CURLOPT_URL, $url );
        curl_setopt ( $curl, CURLOPT_SSL_VERIFYPEER, FALSE );
        curl_setopt ( $curl, CURLOPT_SSL_VERIFYHOST, FALSE );
        if (! empty ( $filedata )) {
            curl_setopt ( $curl, CURLOPT_POST, 1 );
            curl_setopt ( $curl, CURLOPT_POSTFIELDS, $filedata );
        }
        curl_setopt ( $curl, CURLOPT_RETURNTRANSFER, 1 );
        $output = curl_exec ( $curl );
        curl_close ( $curl );
        return $output;

    }

    public static function postImageToServer() {
        $mpAccessToken = static::getMpAccessToken();
        if(!empty($mpAccessToken)){

            $filepath = "/home/kidd/tmp/test.jpeg";
            if (class_exists ( '\CURLFile' )) {//å…³é”®æ˜¯åˆ¤æ–­curlfile,å®˜ç½‘æ¨èphp5.5æˆ–æ›´é«˜çš„ç‰ˆæœ¬ä½¿ç”¨curlfileæ¥å®ä¾‹æ–‡ä»¶
                $filedata = array (
                    'fieldname' => new \CURLFile ( realpath ( $filepath ), 'image/jpeg' )
                );
            } else {
                $filedata = array (
                    'fieldname' => '@' . realpath ( $filepath )
                );
            }
            $url = "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=" . $mpAccessToken . "&type=image";
            $result = self::http_post_media ( $url, $filedata );//è°ƒç”¨uploadå‡½æ•°
            return json_encode($result);

--------- 2016-08-31 10:58:14
    public function actionSendText()
    {
        if (!YII_ENV_PROD) {
            if(Wechat::postMessageToUser("ook-7wLch8xSS-mM-urjLCCs91n0", "morning anhua")) return true;
            else return false;
        }
    }

    public static function postMessageToUser($open_id, $content) {
        $mpAccessToken = static::getMpAccessToken();
        if(!empty($mpAccessToken)){
            $post_data = '{
                "touser":"'.$open_id.'",
                "msgtype":"text",
                "text":
                {
                     "content":"'.$content.'"
                }
            }';

            $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=".$mpAccessToken;
            $header = array(
                'Content-Type: application/json',
                'Content-Length: ' . strlen($post_data));
            $response = static::postContents($url, $post_data, $header, $mpAccessToken);
        }
        else return false;

        return $response;
    }


    public static function postContents($url, $post_data, $header, $token=null, $try_count=0) {
        Logger::logFunctionCall();
        if ($try_count > self::MAX_TRY_COUNT) {
            Logger::warning('post contents failed, reach max try count');
            return false;
        }
        if (!is_null($token)) {
            $full_url = sprintf($url, $token);
        } else {
            $full_url = $url;
        }
        $response =  Util::curl('POST', $full_url, $post_data, $header);
        if(empty($response['res'])){
            Logger::warning('post contents failed, try again');
            return self::postContents($url, $post_data, $header, $token, $try_count+1);
        }
        Logger::info('Response: ' . $response['res']);

        $response = json_decode($response['res'], true);
        if(!empty($response['errcode'])) {
            Logger::error(json_encode($response));
            // check response, if token invalid, refresh token and try again
            if ($response['errcode'] == self::INVALID_TOKEN_CODE && !is_null($token)) {
                Logger::info('access token invalid, refresh token and try again');
                // refresh access token
                $new_token = self::getMpAccessToken(true);
                return self::postContents($url, $post_data, $header, $new_token, $try_count+1);
            }
            return false;
        }
        return $response;
    }


------------ 2016-08-31 11:00:48


class QrcodeController extends WebController
{
    static $string_type = 0;
    static $int_type = 1;
    public function actionCreate()
    {
        $model = new SceneForm;
        $scene_id = null;
        if ($model->load(Yii::$app->request->post()) && $model->validate()) {
            // obtain ticket in order to generate url for qrcode
            if($model->type == self::$string_type) {
                $scene_id = $model->scene_str;
                $post_data = array(
                    'action_name' => 'QR_LIMIT_STR_SCENE',
                    'action_info' => array(
                        'scene' => array(
                            'scene_str' => $scene_id
                        )
                    )
                );
            }
            else {
                $scene_id = $model->scene_id;
                $post_data = array(
                    'action_name' => 'QR_LIMIT_SCENE',
                    'action_info' => array(
                        'scene' => array(
                            'scene_id' => $scene_id
                        )
                    )
                );
            }
            $data_string = json_encode($post_data);
            $response = Wechat::postQrcodeTicket($data_string);
            if(!$response) {
                return $this->render('error');
            }
            $model->ticket = $response['ticket'];
            // save to qrcode_ticket table
            {
                $qr_ticket = QrTicket::find()
                    ->where(['ticket' => $model->ticket])
                    ->one();

                if(empty($qr_ticket)){
                    $qr_ticket = new QrTicket();
                    $qr_ticket->client_event_key = $scene_id;
                    $qr_ticket->type = $model->type;
                    $qr_ticket->ticket = $model->ticket;
                    $qr_ticket->save();
                }
            }
            return $this->render('create_confirm', ['model' => $model]);
        } else {
            $model->type = self::$string_type;
            $model->scene_id = 1111;
            $model->scene_str = 'abc';
            return $this->render('create', ['model' => $model]);
        }
    }

------------ 2016-10-08 19:37:08
$ php yii tools/create-wechat-menu
{"button":[{"type":"view","name":"æˆ‘çš„æŒ‘æˆ˜","url":"https:\/\/wx-dev.yqtz8.com\/mission\/list"},{"type":"view","name":"å‘èµ·æŒ‘æˆ˜","url":"https:\/\/wx-dev.yqtz8.com\/mission\/create"},{"name":"æ›´å¤š","sub_button":[{"type":"click","name":"æˆ‘è¦æ‰“å¡","key":"BUTTON_CHECKIN"},{"type":"click","name":"é‚€è¯·äºŒç»´ç ","key":"BUTTON_TEMP_QRCODE"},{"type":"click","name":"ç¤¾äº¤","key":"BUTTON_SOCIAL"}]}]}/home/kidd/workspace/bc/advanced/MissionImpossible/console/controllers/ToolsController.php:73:
array(2) {
  'res' =>
  string(27) "{"errcode":0,"errmsg":"ok"}"
  'httpCode' =>
  int(200)
}

class ToolsController extends Controller
{

    // Wechat custom menu
    private static $custom_menu = [
        "button" => [
            [
                "type" => "view",
                "name" => "æˆ‘çš„æŒ‘æˆ˜",
                "url" => "https://wx.yqtz8.com/mission/list"
            ],
            [
                "type" => "view",
                "name" => "å‘èµ·æŒ‘æˆ˜",
                "url" => "https://wx.yqtz8.com/mission/create"
            ],
            [
                "name" => "æ›´å¤š",
                "sub_button" => [
                    [
                        "type" => "click",
                        "name" => "æˆ‘è¦æ‰“å¡",
                        "key" => "BUTTON_CHECKIN"
                    ],
                    [
                        "type" => "click",
                        "name" => "é‚€è¯·äºŒç»´ç ",
                        "key" => "BUTTON_TEMP_QRCODE"
                    ],
                    [
                        "type" => "click",
                        "name" => "ç¤¾äº¤",
                        "key" => "BUTTON_SOCIAL"
                    ],
                ],
            ],
        ]
    ];

    public function actionCreateWechatMenu()
    {
        $token = Wechat::getMpAccessToken();
        if (!$token) {
            throw new AppException('è·å–access tokenå¤±è´¥');
        }
        $url = 'https://api.weixin.qq.com/cgi-bin/menu/create?access_token=' . $token;
        $menu_data = json_encode(self::$custom_menu, JSON_UNESCAPED_UNICODE);
        echo $menu_data;
        $res = Util::curl($method = 'POST', $url, $postData = $menu_data);
        var_dump($res);
    }

